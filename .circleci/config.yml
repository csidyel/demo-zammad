version: 2.1
jobs:
  zammad:
    machine:
      - image: ubuntu-2004:current
        environment:
          PGHOST: '127.0.0.1'
          #PGUSER: root
          POSTGRES_USER: zammad
          POSTGRES_PASSWORD: zammad
          RAILS_ENV: test
          Z_LOCALES: "en-us:de-de"
          REDIS_URL: redis://redis:6379
          # Compile assets only once.
          CI_SKIP_ASSETS_PRECOMPILE: 'true'
          # Avoid unnecessary DB resets.
          CI_SKIP_DB_RESET: 'true'      
    resource_class: medium
    steps:
      - checkout
      - restore_cache:
          name: Restore Yarn Package Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
      - restore_cache:
          name: Restore Ruby Cache
          key: cache-gems-{{ checksum "Gemfile.lock" }}
      - run: echo '127.0.0.1 redis postgresql' | sudo tee -a /etc/hosts
      - run: sudo apt update -y
      - run: sudo apt install -y postgresql-client
      - run: sudo apt-get install -y postgresql postgresql-contrib
      - run: sudo apt-get install -y redis-server
      - run: sudo service redis-server start
      - run: .github/workflows/ci/pre.sh
      - run: .github/workflows/ci/lint.sh        
      - run: .github/workflows/ci/test.sh
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - save_cache:
          name: Save Ruby Gems
          key: cache-gems-{{ checksum "Gemfile.lock" }}          
          paths:
            - ~/.bundle

workflows:
  CI-workflow:
    jobs:
      - zammad
