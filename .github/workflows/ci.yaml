name: CI

on: 
  push:
  schedule:
    # Runs every 3 days.
    - cron:  '0 0 */3 * *'
env:
  RAILS_ENV: test
  Z_LOCALES: "en-us:de-de"
  REDIS_URL: redis://redis:6379
  # Compile assets only once.
  CI_SKIP_ASSETS_PRECOMPILE: 'true'
  # Avoid unnecessary DB resets.
  CI_SKIP_DB_RESET: 'true'
jobs:
  Lint:
    runs-on: ubuntu-latest
    container:
      image: zammad/zammad-ci:latest
    services:
      postgresql:
        image: postgres:10
        env:
          POSTGRES_USER: zammad
          POSTGRES_PASSWORD: zammad
      redis:
        # Use Redis 5 which is shipped in Debian 10.
        image: redis:5
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-cache-npm-${{ hashFiles('yarn.lock') }}
      - name: Cache Rubygems
        id: cache-bundler
        uses: actions/cache@v3
        with:
          path: vendor/ruby
          key: ${{ runner.os }}-cache-bundler-${{ hashFiles('Gemfile.lock') }}
      - name: Pre
        run: .github/workflows/ci/pre.sh
      - name: Lint
        run: .github/workflows/ci/lint.sh

  Yarn:
    runs-on: ubuntu-latest
    container:
      image: zammad/zammad-ci:latest  
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-cache-npm-${{ hashFiles('yarn.lock') }}    
        run: yarn install
        run: yarn cypress:install
        run: yarn test
        run: yarn test:ci:ct
  Tests:
    strategy:
      matrix:
        JobIndex: [1,2,3,4]
    runs-on: ubuntu-latest
    container:
      image: zammad/zammad-ci:latest
    services:
      postgresql:
        image: postgres:10
        env:
          POSTGRES_USER: zammad
          POSTGRES_PASSWORD: zammad
      redis:
        # Use Redis 5 which is shipped in Debian 10.
        image: redis:5
    env:
      JOB_INDEX: ${{matrix.JobIndex}}
      JOB_COUNT: ${{strategy.job-total}}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-cache-npm-${{ hashFiles('yarn.lock') }}
      - name: Cache Rubygems
        id: cache-bundler
        uses: actions/cache@v3
        with:
          path: vendor/ruby
          key: ${{ runner.os }}-cache-bundler-${{ hashFiles('Gemfile.lock') }}
      - name: Pre
        run: .github/workflows/ci/pre.sh
      - name: Test
        run: .github/workflows/ci/test.sh
